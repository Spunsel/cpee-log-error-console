<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GraphViewer Test - CPEE Visualization</title>
    <link rel="stylesheet" href="src/libs/cpee-layout/wfadaptor.css">
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 2rem;
            background-color: #f5f5f5;
        }
        .test-container {
            background: white;
            padding: 2rem;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            margin-bottom: 2rem;
        }
        .test-section {
            margin-bottom: 3rem;
        }
        .controls {
            margin-bottom: 2rem;
            padding: 1rem;
            background: #f8f9fa;
            border-radius: 4px;
        }
        .controls button {
            padding: 0.5rem 1rem;
            margin-right: 0.5rem;
            margin-bottom: 0.5rem;
            border: 1px solid #ddd;
            background: white;
            border-radius: 4px;
            cursor: pointer;
        }
        .controls button:hover {
            background: #e9ecef;
        }
        .xml-preview {
            background: #f8f8f8;
            border: 1px solid #ddd;
            padding: 1rem;
            border-radius: 4px;
            font-family: 'Courier New', monospace;
            font-size: 0.9rem;
            margin: 1rem 0;
            overflow-x: auto;
        }
        .graph-container {
            min-height: 400px;
            border: 1px solid #e0e0e0;
            border-radius: 4px;
            background: white;
        }
        .logs {
            background: #2d3748;
            color: #e2e8f0;
            padding: 1rem;
            border-radius: 4px;
            font-family: 'Courier New', monospace;
            font-size: 0.85rem;
            max-height: 200px;
            overflow-y: auto;
        }
        .custom-input-section {
            background: #f8f9fa;
            padding: 1.5rem;
            border-radius: 8px;
            margin-bottom: 2rem;
            border: 1px solid #e9ecef;
        }
        .custom-input-section h3 {
            margin-top: 0;
            color: #2196F3;
        }
        .custom-input-section p {
            margin-bottom: 1rem;
            color: #666;
        }
        #custom-xml-input {
            transition: border-color 0.2s ease;
        }
        #custom-xml-input:focus {
            border-color: #2196F3;
            outline: none;
            box-shadow: 0 0 0 2px rgba(33, 150, 243, 0.2);
        }
    </style>
</head>
<body>
    <h1>üéØ CPEE GraphViewer Test</h1>
    
    <div class="test-container">
        <h2>Interactive Graph Visualization Demo</h2>
        <p>Test the complete CPEE XML to graph rendering pipeline with real data from your logs.</p>
        
        <div class="controls">
            <button onclick="loadSimpleProcess()">üìù Simple Process</button>
            <button onclick="loadComplexProcess()">üîÑ Complex Process</button>
            <button onclick="loadRealLogData()">üìä Real Log Data</button>
            <button onclick="loadParallelProcess()">‚ö° Parallel Process</button>
            <button onclick="loadErrorExample()">‚ùå Error Example</button>
            <button onclick="clearAll()">üßπ Clear All</button>
        </div>
        
        <div class="custom-input-section">
            <h3>üéØ Custom CPEE XML Input</h3>
            <p>Paste your own CPEE XML content below and click "Render Custom XML" to visualize it:</p>
            <textarea id="custom-xml-input" placeholder="Paste your CPEE XML here...
Example:
<?xml version=&quot;1.0&quot;?>
<description xmlns=&quot;http://cpee.org/ns/description/1.0&quot;>
  <call id=&quot;task1&quot; endpoint=&quot;&quot;>
    <parameters>
      <label>Your Custom Task</label>
      <method/>
      <type>:task</type>
    </parameters>
  </call>
</description>" style="width: 100%; height: 200px; font-family: 'Courier New', monospace; font-size: 0.9rem; padding: 1rem; border: 1px solid #ddd; border-radius: 4px; resize: vertical;"></textarea>
            <div style="margin-top: 1rem; display: flex; gap: 1rem; align-items: center;">
                <button onclick="renderCustomXML()" style="padding: 0.75rem 1.5rem; background: #2196F3; color: white; border: none; border-radius: 4px; cursor: pointer; font-weight: 600;">üöÄ Render Custom XML</button>
                <button onclick="clearCustomInput()" style="padding: 0.75rem 1rem; background: #f0f0f0; color: #333; border: 1px solid #ddd; border-radius: 4px; cursor: pointer;">üßπ Clear Input</button>
                <button onclick="loadSampleIntoCustom()" style="padding: 0.75rem 1rem; background: #4CAF50; color: white; border: none; border-radius: 4px; cursor: pointer;">üìã Load Sample</button>
            </div>
        </div>
        
        <div class="test-section">
            <h3>Input CPEE XML:</h3>
            <div id="xml-display" class="xml-preview">
                Click a button above to load sample CPEE XML...
            </div>
        </div>
        
        <div class="test-section">
            <h3>Rendered Graph:</h3>
            <div id="graph-output" class="graph-container">
                <!-- Graph will be rendered here -->
            </div>
        </div>
        
        <div class="test-section">
            <h3>Console Logs:</h3>
            <div id="log-output" class="logs">
                Console output will appear here...
            </div>
        </div>
    </div>
    
    <!-- Load scripts directly instead of ES6 modules -->
    <script src="src/libs/cpee-layout/wfadaptor.js"></script>
    <script>
        // Inline GraphService for simplicity (avoid ES6 module issues)
        class SimpleGraphService {
            static convertCPEEToGraph(cpeeXML) {
                if (!cpeeXML || cpeeXML.trim() === '' || cpeeXML === 'Not found') {
                    return {
                        nodes: [{
                            id: 'empty',
                            type: 'info',
                            label: 'Empty Process',
                            x: 100,
                            y: 50,
                            width: 120,
                            height: 40
                        }],
                        edges: [],
                        layout: 'vertical',
                        type: 'empty'
                    };
                }
                
                try {
                    const parser = new DOMParser();
                    const xmlDoc = parser.parseFromString(cpeeXML, 'text/xml');
                    
                    const parseError = xmlDoc.querySelector('parsererror');
                    if (parseError) {
                        return {
                            nodes: [{
                                id: 'error',
                                type: 'error', 
                                label: 'Parse Error',
                                x: 100,
                                y: 50,
                                width: 140,
                                height: 60
                            }],
                            edges: [],
                            type: 'error'
                        };
                    }
                    
                    const description = xmlDoc.querySelector('description');
                    if (!description) {
                        return {
                            nodes: [{
                                id: 'error',
                                type: 'error',
                                label: 'No Description',
                                x: 100,
                                y: 50,
                                width: 140,
                                height: 60
                            }],
                            edges: [],
                            type: 'error'
                        };
                    }
                    
                    const nodes = [];
                    const edges = [];
                    
                    // Add start node
                    nodes.push({
                        id: 'start',
                        type: 'start',
                        label: 'Start',
                        x: 200,
                        y: 50,
                        width: 80,
                        height: 40
                    });
                    
                    // Process call elements
                    const calls = Array.from(description.querySelectorAll('call'));
                    let previousId = 'start';
                    
                    calls.forEach((call, index) => {
                        const id = call.getAttribute('id') || `call_${index}`;
                        const label = call.querySelector('label')?.textContent || `Task ${index + 1}`;
                        
                        const node = {
                            id: id,
                            type: 'call',
                            label: label,
                            x: 200,
                            y: 120 + (index * 100),
                            width: 120,
                            height: 60
                        };
                        
                        nodes.push(node);
                        
                        edges.push({
                            id: `edge_${previousId}_${id}`,
                            source: previousId,
                            target: id,
                            type: 'sequence'
                        });
                        
                        previousId = id;
                    });
                    
                    // Add end node if we have tasks
                    if (nodes.length > 1) {
                        const endNode = {
                            id: 'end',
                            type: 'end',
                            label: 'End',
                            x: 200,
                            y: 120 + (calls.length * 100),
                            width: 80,
                            height: 40
                        };
                        nodes.push(endNode);
                        
                        edges.push({
                            id: `edge_${previousId}_end`,
                            source: previousId,
                            target: 'end',
                            type: 'sequence'
                        });
                    }
                    
                    return {
                        nodes: nodes,
                        edges: edges,
                        layout: 'vertical',
                        type: 'cpee-process'
                    };
                    
                } catch (error) {
                    console.error('Error parsing CPEE XML:', error);
                    return {
                        nodes: [{
                            id: 'error',
                            type: 'error',
                            label: 'Conversion Error',
                            x: 100,
                            y: 50,
                            width: 140,
                            height: 60
                        }],
                        edges: [],
                        type: 'error'
                    };
                }
            }
        }

        // Simple GraphViewer class (inline)
        class SimpleGraphViewer {
            constructor() {
                this.layoutEngine = null;
                this.containers = new Map();
            }
            
            async renderCPEEGraph(containerId, cpeeXML, title = 'CPEE Process', options = {}) {
                const container = document.getElementById(containerId);
                if (!container) {
                    console.error(`Container ${containerId} not found`);
                    return;
                }
                
                try {
                    const graph = SimpleGraphService.convertCPEEToGraph(cpeeXML);
                    this.createGraphContainer(container, title, options);
                    
                    const svgContainer = container.querySelector('.cpee-svg-container');
                    if (!svgContainer) {
                        throw new Error('SVG container not created');
                    }
                    
                    if (!window.CPEELayoutEngine) {
                        throw new Error('CPEELayoutEngine not available');
                    }
                    
                    const layoutEngine = new window.CPEELayoutEngine(svgContainer, {
                        theme: options.theme || 'default',
                        autoLayout: options.autoLayout !== false,
                        interactive: options.interactive !== false
                    });
                    
                    layoutEngine.render(graph);
                    
                    this.containers.set(containerId, {
                        container,
                        layoutEngine,
                        graph,
                        title
                    });
                    
                    console.log(`Graph rendered in ${containerId}:`, graph);
                    
                } catch (error) {
                    console.error(`Error rendering graph in ${containerId}:`, error);
                    this.renderError(container, `Failed to render graph: ${error.message}`, title);
                }
            }
            
            createGraphContainer(container, title, options) {
                container.innerHTML = '';
                
                const graphContainer = document.createElement('div');
                graphContainer.className = 'cpee-graph-container';
                
                const header = document.createElement('div');
                header.className = 'cpee-graph-header';
                
                const titleElement = document.createElement('h4');
                titleElement.className = 'cpee-graph-title';
                titleElement.textContent = title;
                
                const controls = document.createElement('div');
                controls.className = 'cpee-graph-controls';
                
                if (options.showControls !== false) {
                    const buttons = [
                        { id: 'zoom-in', text: 'üîç+', title: 'Zoom In' },
                        { id: 'zoom-out', text: 'üîç‚àí', title: 'Zoom Out' },
                        { id: 'reset-zoom', text: '‚åÇ', title: 'Reset View' },
                        { id: 'export-svg', text: 'üíæ', title: 'Export SVG' }
                    ];
                    
                    buttons.forEach(btn => {
                        const button = document.createElement('button');
                        button.className = 'cpee-graph-btn';
                        button.textContent = btn.text;
                        button.title = btn.title;
                        button.dataset.action = btn.id;
                        controls.appendChild(button);
                    });
                }
                
                header.appendChild(titleElement);
                header.appendChild(controls);
                
                const svgContainer = document.createElement('div');
                svgContainer.className = 'cpee-svg-container';
                svgContainer.style.minHeight = '300px';
                
                graphContainer.appendChild(header);
                graphContainer.appendChild(svgContainer);
                container.appendChild(graphContainer);
            }
            
            renderError(container, errorMessage, title) {
                container.innerHTML = `
                    <div class="cpee-graph-container">
                        <div class="cpee-graph-header">
                            <h4 class="cpee-graph-title">${this.escapeHtml(title)}</h4>
                        </div>
                        <div class="cpee-svg-container" style="padding: 2rem; text-align: center;">
                            <div style="color: #f44336; font-size: 1.1rem;">
                                ‚ö†Ô∏è ${this.escapeHtml(errorMessage)}
                            </div>
                        </div>
                    </div>
                `;
            }
            
            clearGraph(containerId) {
                const containerData = this.containers.get(containerId);
                if (containerData) {
                    containerData.container.innerHTML = '';
                    this.containers.delete(containerId);
                }
            }
            
            escapeHtml(unsafe) {
                return unsafe
                    .replace(/&/g, "&amp;")
                    .replace(/</g, "&lt;")
                    .replace(/>/g, "&gt;")
                    .replace(/"/g, "&quot;")
                    .replace(/'/g, "&#039;");
            }
        }
        
        // Initialize GraphViewer
        const graphViewer = new SimpleGraphViewer();
        let currentXML = '';
        
        // Sample CPEE XML data (based on your actual log data)
        const sampleData = {
            simple: `<?xml version="1.0"?>
<description xmlns="http://cpee.org/ns/description/1.0">
  <call id="a2" endpoint="">
    <parameters>
      <label>Task A</label>
      <method/>
      <type>:task</type>
      <mid>'1'</mid>
      <arguments/>
    </parameters>
  </call>
</description>`,
            
            complex: `<?xml version="1.0"?>
<description xmlns="http://cpee.org/ns/description/1.0">
  <call id="a2" endpoint="">
    <parameters>
      <label>Task A</label>
      <method/>
      <type>:task</type>
      <mid>'a2'</mid>
      <arguments/>
    </parameters>
  </call>
  <call id="a4" endpoint="">
    <parameters>
      <label>Task B</label>
      <method/>
      <type>:task</type>
      <mid>'b'</mid>
      <arguments/>
    </parameters>
  </call>
</description>`,
            
            realLog: `<?xml version="1.0"?>
<description xmlns="http://cpee.org/ns/description/1.0">
  <call id="a2" endpoint="">
    <parameters>
      <label>Task A</label>
      <method/>
      <type>:task</type>
      <mid>'a2'</mid>
      <arguments/>
    </parameters>
  </call>
  <call id="a4" endpoint="">
    <parameters>
      <label>Task B</label>
      <method/>
      <type>:task</type>
      <mid>'b'</mid>
      <arguments/>
    </parameters>
  </call>
</description>`,
            
            parallel: `<?xml version="1.0"?>
<description xmlns="http://cpee.org/ns/description/1.0">
  <parallel id="par1">
    <call id="task1" endpoint="">
      <parameters>
        <label>Parallel Task 1</label>
        <type>:task</type>
      </parameters>
    </call>
    <call id="task2" endpoint="">
      <parameters>
        <label>Parallel Task 2</label>
        <type>:task</type>
      </parameters>
    </call>
  </parallel>
  <call id="final" endpoint="">
    <parameters>
      <label>Final Task</label>
      <type>:task</type>
    </parameters>
  </call>
</description>`,
            
            error: `<invalid-xml>This is not valid CPEE XML</invalid>`
        };
        
        // Override console.log to capture output
        const originalLog = console.log;
        const originalError = console.error;
        const logOutput = document.getElementById('log-output');
        
        function appendLog(message, type = 'log') {
            const timestamp = new Date().toLocaleTimeString();
            const color = type === 'error' ? '#ff6b6b' : type === 'warn' ? '#ffa726' : '#81c784';
            logOutput.innerHTML += `<div style="color: ${color};">[${timestamp}] ${message}</div>`;
            logOutput.scrollTop = logOutput.scrollHeight;
        }
        
        console.log = (...args) => {
            originalLog(...args);
            appendLog(args.join(' '), 'log');
        };
        
        console.error = (...args) => {
            originalError(...args);
            appendLog(args.join(' '), 'error');
        };
        
        console.warn = (...args) => {
            console.warn(...args);
            appendLog(args.join(' '), 'warn');
        };
        
        // Test functions
        window.loadSimpleProcess = () => {
            loadXMLData(sampleData.simple, 'Simple Process (Single Task)');
        };
        
        window.loadComplexProcess = () => {
            loadXMLData(sampleData.complex, 'Complex Process (Sequential Tasks)');
        };
        
        window.loadRealLogData = () => {
            loadXMLData(sampleData.realLog, 'Real Log Data (From Your CPEE Logs)');
        };
        
        window.loadParallelProcess = () => {
            loadXMLData(sampleData.parallel, 'Parallel Process (Gateway Example)');
        };
        
        window.loadErrorExample = () => {
            loadXMLData(sampleData.error, 'Error Example (Invalid XML)');
        };
        
        window.clearAll = () => {
            document.getElementById('xml-display').textContent = 'Click a button above to load sample CPEE XML...';
            graphViewer.clearGraph('graph-output');
            logOutput.innerHTML = 'Console output will appear here...';
            currentXML = '';
        };
        
        async function loadXMLData(xml, title) {
            currentXML = xml;
            
            // Display XML
            document.getElementById('xml-display').textContent = xml;
            
            // Clear previous logs
            logOutput.innerHTML = '';
            
            console.log(`üöÄ Loading: ${title}`);
            console.log('üìÑ XML Content:', xml.substring(0, 100) + '...');
            
            // Test GraphService conversion
            console.log('üîÑ Converting XML to graph format...');
            const graph = SimpleGraphService.convertCPEEToGraph(xml);
            console.log('üìä Generated graph:', graph);
            
            // Render with GraphViewer
            console.log('üé® Rendering graph with GraphViewer...');
            await graphViewer.renderCPEEGraph('graph-output', xml, title, {
                theme: 'default',
                interactive: true,
                showControls: true
            });
            
            console.log('‚úÖ Graph rendering complete!');
        }
        
        // Set up event listeners for graph interactions
        document.getElementById('graph-output').addEventListener('graphNodeClick', (event) => {
            console.log('üéØ Graph node clicked:', event.detail.node);
            console.log('üìã Node details:', event.detail.node.details || 'No details available');
        });
        
        // Custom XML functions
        window.renderCustomXML = () => {
            const customInput = document.getElementById('custom-xml-input');
            const xmlContent = customInput.value.trim();
            
            if (!xmlContent) {
                alert('Please paste some CPEE XML content first!');
                customInput.focus();
                return;
            }
            
            console.log('üéØ Rendering custom XML from user input');
            loadXMLData(xmlContent, 'Custom CPEE XML');
        };
        
        window.clearCustomInput = () => {
            document.getElementById('custom-xml-input').value = '';
            console.log('üßπ Custom input cleared');
        };
        
        window.loadSampleIntoCustom = () => {
            const sampleXML = sampleData.complex;
            document.getElementById('custom-xml-input').value = sampleXML;
            console.log('üìã Sample XML loaded into custom input');
        };
        
        // Add keyboard shortcut for quick rendering
        document.getElementById('custom-xml-input').addEventListener('keydown', (event) => {
            // Ctrl+Enter or Cmd+Enter to render
            if ((event.ctrlKey || event.metaKey) && event.key === 'Enter') {
                event.preventDefault();
                renderCustomXML();
            }
        });
        
        // Initialize with simple example
        console.log('üéØ GraphViewer Test initialized!');
        console.log('üëÜ Click the buttons above to test different CPEE XML examples');
        console.log('üé® Or paste your own CPEE XML in the custom input section below');
        console.log('üí° Tip: Use Ctrl+Enter in the text area to quickly render your XML');
    </script>
</body>
</html>
